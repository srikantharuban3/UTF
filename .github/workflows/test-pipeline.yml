name: AI-Powered Playwright MCP Test Suite

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  run-ai-playwright-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm init -y
          npm install playwright @playwright/test @anthropic-ai/sdk
          npx playwright install chromium

      - name: Create AI-powered test executor
        run: |
          mkdir -p reports
          cat > ai-test-executor.js << 'EOF'
          const fs = require('fs');
          const { execSync } = require('child_process');
          const Anthropic = require('@anthropic-ai/sdk');

          async function executeTestWithAI() {
            try {
              console.log('üß† Starting AI-powered test execution...');
              
              // Read the test suite
              const testSuite = fs.readFileSync('Testsuite.md', 'utf8');
              console.log('üìñ Read test suite from Testsuite.md');
              
              // Initialize Claude AI
              const anthropic = new Anthropic({
                apiKey: process.env.ANTHROPIC_API_KEY,
              });

              // Generate Playwright test from the test suite
              const prompt = `
              Based on the following test suite, generate a complete Playwright test script that:
              1. Implements TC 001 exactly as described
              2. Uses a unique 10-character username as specified
              3. Includes proper error handling and assertions
              4. Generates detailed console output for each step
              
              Test Suite:
              ${testSuite}
              
              Please provide only the JavaScript code for a complete Playwright test file:
              `;

              console.log('ü§ñ Sending test suite to Claude AI...');
              const response = await anthropic.messages.create({
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 4000,
                messages: [{ role: 'user', content: prompt }]
              });

              const testCode = response.content[0].text;
              console.log('‚úÖ Received AI-generated test code');
              
              // Save the generated test
              fs.writeFileSync('generated-test.spec.js', testCode);
              console.log('üíæ Saved AI-generated test to generated-test.spec.js');
              
              // Create Playwright config
              const playwrightConfig = `
              module.exports = {
                testDir: '.',
                timeout: 120000,
                use: {
                  headless: true,
                  viewport: { width: 1920, height: 1080 },
                  screenshot: 'only-on-failure',
                  video: 'retain-on-failure',
                },
                projects: [
                  {
                    name: 'chromium',
                    use: { channel: 'chrome' },
                  },
                ],
                reporter: [
                  ['html', { outputFolder: 'reports/playwright-report' }],
                  ['json', { outputFile: 'reports/test-results.json' }]
                ],
              };
              `;
              fs.writeFileSync('playwright.config.js', playwrightConfig);
              
              // Execute the test
              console.log('üöÄ Executing AI-generated test...');
              execSync('npx playwright test generated-test.spec.js', { 
                stdio: 'inherit',
                env: { ...process.env }
              });
              
              console.log('‚úÖ Test execution completed');
              
              // Generate summary report
              const summaryHtml = `
              <!DOCTYPE html>
              <html>
              <head>
                <title>AI-Powered Test Execution Report</title>
                <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background: #4CAF50; color: white; padding: 20px; text-align: center; }
                  .content { padding: 20px; }
                  .success { color: #4CAF50; font-weight: bold; }
                  .info { background: #f0f0f0; padding: 15px; border-left: 4px solid #2196F3; }
                </style>
              </head>
              <body>
                <div class="header">
                  <h1>ü§ñ AI-Powered Test Execution Report</h1>
                  <p>Generated by Claude AI on ${new Date().toLocaleString()}</p>
                </div>
                <div class="content">
                  <h2>Test Summary</h2>
                  <p class="success">‚úÖ Test execution completed successfully</p>
                  
                  <div class="info">
                    <h3>Test Case Executed:</h3>
                    <p><strong>TC 001</strong> - Verify that user can register a new customer</p>
                    <ul>
                      <li>Navigate to ParaBank website</li>
                      <li>Click on Register link</li>
                      <li>Fill registration form with unique 10-character username</li>
                      <li>Submit the form</li>
                      <li>Verify welcome message with new username</li>
                    </ul>
                  </div>
                  
                  <h3>AI Model Used:</h3>
                  <p>Claude 3.5 Sonnet</p>
                  
                  <h3>Browser:</h3>
                  <p>Chromium (Headless)</p>
                  
                  <h3>Generated At:</h3>
                  <p>${new Date().toISOString()}</p>
                </div>
              </body>
              </html>
              `;
              
              fs.writeFileSync('reports/test-execution-report.html', summaryHtml);
              console.log('üìä Generated HTML test report');
              
            } catch (error) {
              console.error('‚ùå Error during AI test execution:', error);
              
              // Generate error report
              const errorHtml = `
              <!DOCTYPE html>
              <html>
              <head>
                <title>Test Execution Error</title>
                <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background: #f44336; color: white; padding: 20px; text-align: center; }
                  .error { background: #ffebee; padding: 15px; border-left: 4px solid #f44336; }
                </style>
              </head>
              <body>
                <div class="header">
                  <h1>‚ùå Test Execution Error</h1>
                </div>
                <div class="error">
                  <h3>Error Details:</h3>
                  <pre>${error.message}</pre>
                  <p>Generated at: ${new Date().toLocaleString()}</p>
                </div>
              </body>
              </html>
              `;
              
              fs.writeFileSync('reports/test-execution-report.html', errorHtml);
              process.exit(1);
            }
          }

          executeTestWithAI();
          EOF

      - name: Run AI Test Executor
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üß† Starting AI-powered test execution with Claude..."
          node ai-test-executor.js

      - name: Upload HTML Test Report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-mcp-test-report
          path: reports/test-execution-report.html

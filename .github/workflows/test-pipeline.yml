name: AI-Powered Playwright MCP Test Suite

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  run-ai-playwright-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm init -y
          npm install playwright @playwright/test @playwright/mcp node-fetch
          npx playwright install --with-deps chromium
          npm install @playwright/mcp

      - name: Start Playwright MCP server
        run: |
          echo "üöÄ Starting Playwright MCP server..."
          nohup npx @playwright/mcp server > mcp.log 2>&1 &
          sleep 8
          echo "‚úÖ MCP server started"

      - name: üß† Run AI Test Suite via Playwright MCP
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MCP_MODEL: claude-3-5-sonnet
        run: |
          echo "üß† Sending test suite to Claude via MCP..."
    
          # Ensure reports folder exists
          mkdir -p reports

          # Copy Testsuite.md as input.md for MCP
          cp Testsuite.md input.md

          # Run MCP and capture full logs
          npx @playwright/mcp > mcp_output.log 2>&1 || true

          echo "üß© Parsing MCP output..."
          TOTAL=$(grep -Eic "test case" mcp_output.log || echo 0)
          PASSED=$(grep -Eic "pass|successful" mcp_output.log || echo 0)
          FAILED=$(grep -Eic "fail|error|assertion" mcp_output.log || echo 0)
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

          # Decide job status (for pipeline)
          if [ "$FAILED" -gt 0 ]; then
            STATUS="‚ùå FAILED"
            EXITCODE=1
          elif [ "$PASSED" -gt 0 ]; then
            STATUS="‚úÖ PASSED"
            EXITCODE=0
          else
            STATUS="‚ö†Ô∏è NO TEST RESULTS"
            EXITCODE=2
          fi

          echo "üìä Generating AI Test Execution HTML report..."
          REPORT="reports/test-execution-report.html"

          # Create detailed HTML report
          cat <<EOF > $REPORT
          <!DOCTYPE html>
          <html>
          <head>
            <title>AI Test Execution Report</title>
            <style>
              body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
              h1 { color: #333; }
              .status { font-size: 20px; margin-bottom: 10px; }
              .summary { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
              pre { background: #222; color: #eee; padding: 10px; border-radius: 6px; overflow-x: auto; }
              canvas { margin-top: 15px; }
            </style>
          </head>
          <body>
            <h1>AI Test Execution Report</h1>
            <div class="summary">
              <p class="status"><strong>Status:</strong> $STATUS</p>
              <p><strong>Total:</strong> $TOTAL</p>
              <p><strong>Passed:</strong> $PASSED</p>
              <p><strong>Failed:</strong> $FAILED</p>
              <p><strong>Executed At:</strong> $TIMESTAMP</p>
              <canvas id="chart" width="400" height="200"></canvas>
            </div>

            <h3>Execution Log</h3>
            <pre>$(head -n 100 mcp_output.log)</pre>

            <script>
              const ctx = document.getElementById('chart').getContext('2d');
              const data = {
                labels: ['Passed', 'Failed'],
                datasets: [{
                  label: 'Test Summary',
                  data: [$PASSED, $FAILED],
                  backgroundColor: ['#4CAF50', '#E74C3C']
                }]
              };
              new Chart(ctx, { type: 'bar', data });
            </script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          </body>
          </html>
          EOF

          echo "‚úÖ HTML report generated at $REPORT"
          echo "üßæ STATUS: $STATUS"

          exit $EXITCODE

      - name: Upload HTML Test Report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-mcp-test-report
          path: reports/test-execution-report.html
